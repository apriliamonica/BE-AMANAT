// prisma/schema.prisma - AMANAT App (Updated untuk SOP)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  ADMIN                    // Admin sistem (Sekretaris Kantor)
  KETUA_PENGURUS           // Ketua Yayasan
  SEKRETARIS_PENGURUS      // Sekretaris Pengurus
  BENDAHARA_PENGURUS       // Bendahara
  KEPALA_BAGIAN_PSDM       // Kepala Bagian PSDM
  KEPALA_BAGIAN_KEUANGAN   // Kepala Bagian Keuangan
  KEPALA_BAGIAN_UMUM       // Kepala Bagian Umum
}

enum JenisSurat {
  MASUK
  KELUAR
  LAMPIRAN
}

// Status untuk Surat Masuk (6 tahap)
enum StatusSuratMasuk {
  DITERIMA                 // Tahap 1: Sekretaris Kantor terima surat
  DIPROSES                 // Tahap 2: Sekretaris Kantor proses verifikasi
  DISPOSISI_KETUA          // Tahap 3: Ketua review & buat disposisi
  DISPOSISI_SEKPENGURUS    // Tahap 4: Sekpengurus koordinasi & disposisi
  DISPOSISI_KABAG          // Tahap 5: Kabag proses & upload hasil
  SELESAI                  // Tahap 6: Diarsipkan
}

// Status untuk Surat Keluar (5 tahap)
enum StatusSuratKeluar {
  DRAFT                    // Tahap 1: Sekretaris Kantor buat draft
  REVIEW_SEKPENGURUS       // Tahap 2: Sekpengurus review
  LAMPIRAN_KABAG           // Tahap 3: (Optional) Kabag upload lampiran
  REVIEW_KETUA             // Tahap 4: Ketua review & TTD
  TERKIRIM                 // Tahap 5: Final & diarsipkan
}

enum StatusDisposisi {
  PENDING                  // Belum dibaca/diproses
  DITERIMA                 // Sudah diterima
  DIPROSES                 // Sedang diproses
  SELESAI                  // Selesai
  DITOLAK                  // Ditolak/dikembalikan
}


enum JenisKategori {
  UNDANGAN
  PERMOHONAN
  PEMBERITAHUAN
  VERIFIKASI
  AUDIT
  LAINNYA
}

// ==================== MODELS ====================

model User {
  id              String   @id @default(uuid())
  nama_lengkap    String
  email           String   @unique
  username        String   @unique
  password        String   // Hash dengan bcrypt
  role            Role
  kodeBagian      String?  // PSDM, KEU, UMUM (untuk kepala bagian)
  jabatan         String?  // Jabatan spesifik
  phone           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  suratMasukCreatedBy      SuratMasuk[]        @relation("SuratMasukCreatedBy")
  suratKeluarCreatedBy     SuratKeluar[]       @relation("SuratKeluarCreatedBy")
  
  disposisiFrom            Disposisi[]         @relation("DisposisiFrom")
  disposisiTo              Disposisi[]         @relation("DisposisiTo")
  
  trackingCreatedBy        TrackingSurat[]

  @@map("users")
  @@index([email])
  @@index([username])
  @@index([role])
}

// ==================== SURAT MASUK ====================

model SuratMasuk {
  id              String              @id @default(uuid())
  nomorSurat      String              // Nomor dari pengirim
  tanggalSurat    DateTime
  tanggalDiterima DateTime            @default(now())
  asalSurat       String              // Instansi pengirim
  perihal         String              @db.Text
  kategori        JenisKategori
  namaPengirim    String?
  status          StatusSuratMasuk    @default(DITERIMA)
  
  // Metadata
  createdById     String
  createdBy       User                @relation("SuratMasukCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  lampiran        Lampiran[]
  disposisi       Disposisi[]
  tracking        TrackingSurat[]
  suratBalasan    SuratKeluar[]       @relation("SuratBalasan")  // Surat keluar yang merupakan balasan

  @@map("surat_masuk")
  @@index([status])
  @@index([tanggalDiterima])
}

// ==================== SURAT KELUAR ====================

model SuratKeluar {
  id              String              @id @default(uuid())
  nomorSurat      String              @unique      // Nomor surat keluar
  tanggalSurat    DateTime
  
  // Penerima
  tujuanSurat     String              // Nama instansi/penerima
  
  // Detail
  perihal         String              @db.Text
  kategori        JenisKategori
  status          StatusSuratKeluar   @default(DRAFT)
  
  // Link ke surat masuk (jika ini adalah surat balasan)
  balasanDariSuratMasukId String?
  balasanDariSuratMasuk   SuratMasuk? @relation("SuratBalasan", fields: [balasanDariSuratMasukId], references: [id])
  
  // Metadata
  catatan         String?             @db.Text
  createdById     String
  createdBy       User                @relation("SuratKeluarCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  lampiran        Lampiran[]
  tracking        TrackingSurat[]
  disposisi       Disposisi[]         @relation("DisposisiSuratKeluar")

  @@map("surat_keluar")
  @@index([nomorSurat])
  @@index([status])
  @@index([tanggalSurat])
}


// ==================== DISPOSISI ====================

model Disposisi {
  id              String              @id @default(uuid())
  
  // Relasi Surat
  suratMasukId    String?
  suratMasuk      SuratMasuk?         @relation(fields: [suratMasukId], references: [id], onDelete: Cascade)
  
  suratKeluarId   String?
  suratKeluar     SuratKeluar?        @relation("DisposisiSuratKeluar", fields: [suratKeluarId], references: [id], onDelete: Cascade)
  
  // From & To
  fromUserId      String
  fromUser        User                @relation("DisposisiFrom", fields: [fromUserId], references: [id])
  
  toUserId        String
  toUser          User                @relation("DisposisiTo", fields: [toUserId], references: [id])
  
  // Detail Disposisi
  instruksi       String              @db.Text    // Instruksi/catatan disposisi
  jenisDispo      String              // "TRANSFER", "REQUEST_LAMPIRAN", "APPROVAL", dll
  tahapProses     String              // "DITERIMA", "DIPROSES", dll - untuk tracking
  status          StatusDisposisi     @default(PENDING)
  tenggatWaktu    DateTime?
  
  // Timestamp
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  selesaiAt       DateTime?

  @@map("disposisi")
  @@index([suratMasukId])
  @@index([suratKeluarId])
  @@index([toUserId])
  @@index([status])
}

// ==================== LAMPIRAN ====================

model Lampiran {
  id              String              @id @default(uuid())
  
  // Relasi (Polymorphic)
  suratMasukId    String?
  suratMasuk      SuratMasuk?         @relation(fields: [suratMasukId], references: [id], onDelete: Cascade)
  
  suratKeluarId   String?
  suratKeluar     SuratKeluar?        @relation(fields: [suratKeluarId], references: [id], onDelete: Cascade)
  
  // File Info
  namaFile        String              // Original filename
  namaTersimpan   String              // Hashed filename
  path            String              // File path
  ukuran          Int                 // Size in bytes
  mimeType        String              // MIME type
  
  // Metadata
  keterangan      String?
  uploadedAt      DateTime            @default(now())


  @@index([suratMasukId])
  @@index([suratKeluarId])
}

// ==================== TRACKING SURAT ====================

model TrackingSurat {
  id              String              @id @default(uuid())
  
  // Relasi (Polymorphic)
  suratMasukId    String?
  suratMasuk      SuratMasuk?         @relation(fields: [suratMasukId], references: [id], onDelete: Cascade)
  
  suratKeluarId   String?
  suratKeluar     SuratKeluar?        @relation(fields: [suratKeluarId], references: [id], onDelete: Cascade)
  
 
  // Tracking Info
  tahapProses     String              // "DITERIMA", "DIPROSES", "DISPOSISI_KETUA", dll
  posisiSaat      String              // Nama user/role saat ini handle
  aksiDilakukan   String              @db.Text // Aksi apa yang dilakukan
  statusTracking  String              // Status pada tahap ini
  
  createdById     String
  createdBy       User                @relation(fields: [createdById], references: [id])
  createdAt       DateTime            @default(now())

  @@map("tracking_surat")
  @@index([suratMasukId])
  @@index([suratKeluarId])
  @@index([tahapProses])
  @@index([createdAt])
}

// ==================== SETTINGS ====================

model Settings {
  id              String              @id @default(uuid())
  key             String              @unique
  value           String              @db.Text
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("settings")
}
